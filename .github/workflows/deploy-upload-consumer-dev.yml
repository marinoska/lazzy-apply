name: Deploy Upload Queue Consumer (Dev)

on:
  push:
    branches:
      - main
    paths:
      - "apps/upload-queue-consumer/**"
      - ".github/workflows/deploy-upload-consumer-dev.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers (Dev Environment)

    # ðŸ”‘ Attach the job to the 'dev' environment
    environment: dev

    # Make token available to all run steps
    # env:
    #   CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    # Optional: default working directory for run steps
    defaults:
      run:
        working-directory: apps/upload-queue-consumer

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
    
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Debug step to prove the env var is visible
      - name: Debug Cloudflare env
        run: env | grep CLOUDFLARE || echo "no CLOUDFLARE vars"

      # - name: Deploy to Cloudflare Workers (Dev)
      #   run: pnpm exec wrangler deploy --env dev
      - name: Deploy to Cloudflare Workers (Dev)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: pnpm exec wrangler deploy --env dev

        
      - name: Set secrets for dev environment
        env:
          # DEV_MONGO_CONNECTION is also an environment secret in 'dev'
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DEV_MONGO_CONNECTION: ${{ secrets.DEV_MONGO_CONNECTION }}
        run: |
          echo "$DEV_MONGO_CONNECTION" | pnpm exec wrangler secret put MONGO_CONNECTION --env dev
