name = "upload-queue-consumer"
main = "src/index.ts"
compatibility_date = "2025-01-13"
compatibility_flags = ["nodejs_compat"]

############################
# Default (PRODUCTION) ENV #
############################

# Queue Consumer – reads messages from the main parse-cv queue
[[queues.consumers]]
queue = "parse-cv"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "parse-cv-dlq"

# Queue Producer – used by your worker to send messages to the DLQ
[[queues.producers]]
binding = "PARSE_CV_DLQ"
queue = "parse-cv-dlq"

# R2 Bucket binding
# - bucket_name is used in production deploys
# - preview_bucket_name is used by `wrangler dev` (preview)
[[r2_buckets]]
binding = "UPLOADS_BUCKET"
bucket_name = "prod"
preview_bucket_name = "dev"
remote = true

# Non-secret vars (secrets still via `wrangler secret put`)
[vars]
ENVIRONMENT = "prod"
API_URL = "https://api.yourapp.com"  # Update with your production API URL

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

##############
# DEV ENV    #
##############

[env.dev]
name = "upload-queue-consumer-dev"

# Dev-specific queues (completely separate from prod)
[[env.dev.queues.consumers]]
queue = "parse-cv-dev"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "parse-cv-dlq-dev"

[[env.dev.queues.producers]]
binding = "PARSE_CV_DLQ"
queue = "parse-cv-dlq-dev"

# Dev R2 bucket
[[env.dev.r2_buckets]]
binding = "UPLOADS_BUCKET"
bucket_name = "dev"
preview_bucket_name = "dev"
remote = true

[env.dev.vars]
ENVIRONMENT = "dev"
API_URL = "https://lazzyapply-api-dev.onrender.com"
